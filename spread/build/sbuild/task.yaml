environment:
    DEB_BUILD_OPTIONS: "parallel=$( nproc ) noopt ${NOCHECK}"
    NO_PKG_MANGLE: 1

systems: [ubuntu-20.04*]

summary: Build Ubuntu packages

execute: |
    apt-get update

    # to get dpkg-architecture and mk-build-deps
    apt-get install \
      --yes \
      --no-install-recommends \
      autopkgtest \
      debhelper \
      dh-python \
      sbuild \
      ubuntu-dev-tools

    lxd init --auto

    # go to the code directory
    cd $SPREAD_PATH

    # mark the "release" in the changelog
    debchange --release "CI release"

    # build the packages
    sbuild -d focal --chroot-mode=autopkgtest --autopkgtest-virt-server=autopkgtest-virt-lxd --autopkgtest-virt-server-opt=ubuntu:20.04 --jobs=$( nproc )
